<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Twitch Tamagotchi</title>
</head>
<body>
<div id="tamagotchi">
    <h1 id="name"></h1>
    <p id="age"></p>
    <p id="energy"></p>
    <p id="happy"></p>
    <p id="hunger"></p>
    <p id="clean"></p>
    <p id="state"></p>
</div>
<canvas id="tamagotchiCanvas" width="160" height="160"></canvas>
<p>Commands</p>
<ul>
    <li>!feed</li>
    <li>!sleep</li>
    <li>!clean</li>
    <li>!play</li>
</ul>
<script>
    const mametchi_adult = [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0],
        [0,0,0,1,1,1,1,0,0,0,1,1,1,1,0,0],
        [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
        [0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
        [0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,0],
        [0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0],
        [0,1,0,0,0,0,1,1,1,0,0,0,0,0,1,0],
        [0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0],
        [0,1,0,0,1,0,0,0,0,0,0,1,0,1,0,0],
        [0,0,1,1,0,0,0,0,0,0,0,1,1,1,0,0],
        [0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,0,1,0,1,1,1,0,0,1,0,0,0,0],
        [0,0,0,0,1,0,1,0,0,1,1,0,0,0,0,0],
        [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0]
    ];

    const mametchi_baby = [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,0,1,0,1,1,1,0,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0],
        [0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    ];

    const mametchi_young = [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],
        [0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,1,1,0,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    ];

    const mametchi_young_adult = [
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
        [0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],
        [0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,1,0,0,0,1,1,0,0,0,1,0,0,0],
        [0,0,1,1,0,0,0,0,0,0,0,1,1,1,0,0],
        [0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0],
        [0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,1,0,1,1,0,1,0,0,0,0,0],
        [0,0,0,0,0,1,0,1,0,1,0,0,0,0,0,0],
        [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    ];

    const canvas = document.getElementById('tamagotchiCanvas');
    const ctx = canvas.getContext('2d');
    const pixelSize = 10;

    ctx.fillStyle = 'black';

    let invert = false;
  let eventSource = new EventSource('sse');

    const getEmojis = (value, emoji) => {
        const count = Math.round(value / 25);
        return emoji.repeat(count);
    }

  eventSource.onmessage = (event) => {
      let name = document.getElementById("name");
      let age = document.getElementById("age");
      let energy = document.getElementById("energy");
      let happy = document.getElementById("happy");
      let hunger = document.getElementById("hunger");
      let clean = document.getElementById("clean");
      let state = document.getElementById("state");
      let tamagotchi = JSON.parse(event.data);
      name.innerText = tamagotchi.name;

      if(tamagotchi.health === "Dead") {
            age.innerText =
            happy.innerText =
            energy.innerText =
            hunger.innerText =
            clean.innerText =
            state.innerText = "";
      } else {
          age.innerText = `Age: ${tamagotchi.age}`;
          happy.innerText = `Happy: ${getEmojis(tamagotchi.health.Healthy[0].happy, "üòÉ")}`;
          energy.innerText = `Energy: ${getEmojis(tamagotchi.health.Healthy[0].energy, "‚ö°")}`;
          hunger.innerText = `Hunger: ${getEmojis(tamagotchi.health.Healthy[0].hunger, "üçñ")}`;
          clean.innerText = `Clean: ${getEmojis(tamagotchi.health.Healthy[0].clean, "üßº")}`;
          state.innerText = `State: ${tamagotchi.health.Healthy[1]}`;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let anim, anim_inverted;
      switch(true) {
          case tamagotchi.age < 50:
              anim = mametchi_baby;
              anim_inverted = mametchi_baby.map(row => row.slice().reverse());
              break;
          case tamagotchi.age < 100:
              anim = mametchi_young;
              anim_inverted = mametchi_young.map(row => row.slice().reverse());
              break;
          case tamagotchi.age < 150:
              anim = mametchi_young_adult;
              anim_inverted = mametchi_young_adult.map(row => row.slice().reverse());
              break;
          default:
              anim = mametchi_adult;
              anim_inverted = mametchi_adult.map(row => row.slice().reverse());
      }
      if (invert) {
          for (let y = 0; y < anim_inverted.length; y++) {
              for (let x = 0; x < anim_inverted[y].length; x++) {
                  if (anim_inverted[y][x]) {
                      ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                  }
              }
          }
      } else {
          for (let y = 0; y < anim.length; y++) {
              for (let x = 0; x < anim[y].length; x++) {
                  if (anim[y][x]) {
                      ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                  }
              }
          }
      }
      invert = !invert;
    }
</script>
</body>
</html>